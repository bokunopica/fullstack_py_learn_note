# 操作系统

## 操作系统的定义

- 操作系统是一个大型系统程序
  - 提供用户接口，方便用户控制计算机
  - 负责为应用程序分配和调度软硬件资源，并控制与协调应用程序并发活动，帮助用户存取和保护信息

## 操作系统的功能

1. 进程管理(CPU)
   - 进程控制：创建 暂停 唤醒 撤销
   - 进程调度：调度策略 优先级
   - 进程通信：进程间通信
2. 内存管理
   - 内存分配
   - 内存共享
   - 内存保护
   - 虚拟内存
3. 设备管理
   - 设备的分配和调度
   - 设备无关性
   - 设备传输控制
   - 设备驱动
4. 文件管理
   - 存储空间管理
   - 文件的操作
   - 目录的操作
   - 文件和目录的存取权限管理

## 操作系统发展历史

1. 手工操作（无操作系统）
2. 单道批处理系统
   - 作业队列
3. 多道批处理系统
   - 外设io和cpu计算两个不相关的操作可以并行处理
4. 分时操作系统
   - cpu中断技术

## 操作系统逻辑结构

1. 整体式结构
   - 模块设计，编码和调试独立
   - 模块调用自由
   - 模块通信多以全局变量形式完成
2. 层次结构
   - 分层
3. 微内核结构
   - 微内核+核外服务器

## CPU的态(mode)

- 定义
  - CPU的工作状态
  - 对资源和指令使用权限的描述
- 特权指令
  - LGDT/LIDT 装载特殊寄存器
  - CLTS 清除任务开关标志
  - STI/CTI 允许和禁止中断
  - HALT 停止CPU的工作
  - IN/OUT 执行I/O操作
  - 从核态转回用户态
- 态的分类
  - 核态（kernel mode）
    - 能够访问所有资源和执行所有指令
    - 管理程序/os内核
  - 用户态（user mode, 目态）
    - 仅能访问部分资源，其他资源受限
    - 用户程序
  - 管态（supervisor mode）
    - 介于核态和用户态之间
- 态的转换
  - 用户态->核态
    - 用户请求OS提供服务
    - 发生中断
    - 用户进程产生错误（内部中断）
    - 用户态企图执行特权命令
  - 核态->用户态
    - 一般是执行中断返回：IRET
- 硬件和OS对CPU的观察
  - 硬件按态区分
  - OS按进程区分
- CPU读取指令或数据时的访问顺序
  1. 访问缓存
  2. 访问内存
  3. 访问辅存

## 中断

- 定义
  - CPU对突发的外部事件的反应过程或机制
  - CPU收到外部信号（中断信号）后，停止当前工作，转去处理该外部事件，处理完毕后回到原来工作的中断处（断点）继续原来的工作
- 目的
  - 实现并发活动
  - 实现实时处理
  - 故障自动处理
- 中断源和中断类型
  - 引起系统中断的事件称为中断源
  - 类型
    - 强迫性中断：程序没有预期：例：I/O、外部中断
    - 自愿中断：程序有预期的：例：执行访管指令
    - 外中断：CPU外部事件引起：例：I/O、外部事件
    - 内中断：例：访管中断、程序中断
    - 不可屏蔽中断 CPU必须响应
    - 可屏蔽中断 CPU可以不响应
- 断点
  - 程序中断的地方，将要执行的下一指令的地址
  - CS:IP
- 现场
  - 程序正确运行所以来的信息集合
    - 相关寄存器
- 现场的两个处理过程
  - 现场的保护：进入中断服务程序之前，栈
  - 现场的恢复：退出中断服务程序之后，栈
- 中断响应过程
  1. 识别中断源
  2. 保护断点和现场
  3. 装入中断服务程序的入口地址（CS:IP）
  4. 进入中断服务程序
  5. 恢复现场和断电
  6. 中断返回 IRET
- 中断响应的实质
  - 交换指令执行地址
  - 交换CPU的态
  - 工作
    - 现场保护和恢复
    - 参数传递(通信)

